
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Plot one frame from the MO global analysis video &#8212; Machine Learning GCM</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Make wind speckles for the MO global analysis video" href="make_z.html" />
    <link rel="prev" title="Assemble data for the Met Office Global Analysis video" href="data.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="make_z.html" title="Make wind speckles for the MO global analysis video"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="data.html" title="Assemble data for the Met Office Global Analysis video"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ML GCM</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Visualising the Met Office Global Analysis</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/Weather-Network.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html"> Big data: Near-surface temperature, wind, and precipitation, from the Met Office global analysis</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../20CRv2c_global_analysis/index.html"> Medium-sized data: Near-surface temperature, wind, and mean-sea-level pressure, from the Twentieth Century Reanalysis version 2c</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Small Print</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/ML_GCM">Get the source code</a></h3>

<a href="https://github.com/philip-brohan/ML_GCM"
           rel="nofollow">Github source repository</a>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/ML_GCM/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="plot-one-frame-from-the-mo-global-analysis-video">
<h1>Plot one frame from the MO global analysis video<a class="headerlink" href="#plot-one-frame-from-the-mo-global-analysis-video" title="Permalink to this headline">¶</a></h1>
<p>The video shows temperature, wind, and precipitation. Getting three variuables into one image requires some care in presentation, particularly in the choice of colours used.</p>
<ul class="simple">
<li>The temperature is a colour map. It is quantile normalised - that is, the temperature field is scaled so that it’s distribution is flat - this means that the image shows the same amount of each colour. Also, the temperatures are adjusted to enhance the weather variability, and supress the climatological variability and the diurnal cycle (the temperature anomalies are doubled, and the diurnal cycle reduced to 1/4 of it’s real size). This allows diurnal variability, the annual cycle, fixed effects like orography and the gulf stream, and weather-timescale variability, all to be shown in the same plot, without any one component dominating.</li>
<li>Precipitation is only shown where it exceeds a threshold value (very light precipitation is missing). It is plotted on a log scale, using the ‘algae’ colour scale from <a class="reference external" href="https://matplotlib.org/cmocean/">cmocean</a>, adjusted to taper to transparency at the bottom end.</li>
<li>Wind is shown as advected speckles - a random field advected along with the wind vectors - this turns the speckles into stripes in the direction of the wind. They can be made to move from frame to frame by advecting most them a little more each timestep (and resetting a few of them to zero advection). This is plotted by adding the wind field to the temperature and precipitation fields before plotting them. The field has mean zero so it has no average effect, but it perturbs the other fields in a way which shows the wind structure.</li>
</ul>
<p>Script to make a single frame:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Atmospheric state - near-surface temperature, wind, and precip.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">IRData.opfc</span> <span class="k">as</span> <span class="nn">opfc</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="k">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="k">import</span> <span class="n">Line2D</span>

<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">qcut</span>

<span class="kn">from</span> <span class="nn">load_step</span> <span class="k">import</span> <span class="n">load_recent_temperatures</span>
<span class="kn">from</span> <span class="nn">load_step</span> <span class="k">import</span> <span class="n">load_li_precip</span>
<span class="kn">from</span> <span class="nn">load_step</span> <span class="k">import</span> <span class="n">load_di_icec</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/../../lib/&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">plots</span> <span class="k">import</span> <span class="n">quantile_normalise_t2m</span>
<span class="kn">from</span> <span class="nn">plots</span> <span class="k">import</span> <span class="n">plot_cube</span>
<span class="kn">from</span> <span class="nn">plots</span> <span class="k">import</span> <span class="n">wind_field</span>
<span class="kn">from</span> <span class="nn">plots</span> <span class="k">import</span> <span class="n">get_precip_colours</span>
<span class="kn">from</span> <span class="nn">plots</span> <span class="k">import</span> <span class="n">draw_lat_lon</span>

<span class="c1"># Fix dask SPICE bug</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;single-threaded&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--year&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--month&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Integer month&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--day&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Day of month&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hour&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time of day (0 to 23.99)&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--pole_latitude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Latitude of projection pole&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--pole_longitude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Longitude of projection pole&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--npg_longitude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Longitude of view centre&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--zoom&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Scale factor for viewport (1=global)&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--opdir&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory for output files&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images/opfc_global_3var_meanp&quot;</span> <span class="o">%</span> \
                                           <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--zfile&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Noise pickle file name&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images/opfc_global_3var/z.pkl&quot;</span> <span class="o">%</span> \
                                           <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">opdir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">opdir</span><span class="p">)</span>

<span class="n">dte</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                      <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hour</span><span class="o">%</span><span class="mi">1</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>

<span class="c1"># In the  temperature field, damp the diurnal cycle, and</span>
<span class="c1">#  boost the short-timescale variability. Load the </span>
<span class="c1">#  recent data to calculate this.</span>
<span class="p">(</span><span class="n">tavg</span><span class="p">,</span><span class="n">davg</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_recent_temperatures</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>

<span class="c1"># Load the model data </span>
<span class="n">t2m</span><span class="o">=</span><span class="n">opfc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;air.2m&#39;</span><span class="p">,</span><span class="n">dte</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">)</span>
<span class="c1"># Remove the diurnal cycle</span>
<span class="n">t2m</span><span class="o">.</span><span class="n">data</span> <span class="o">-=</span> <span class="n">davg</span><span class="o">.</span><span class="n">data</span>
<span class="c1"># Double the synoptic variability</span>
<span class="n">t2m</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="n">t2m</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">tavg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
<span class="c1"># Add back a reduced diurnal cycle</span>
<span class="n">t2m</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">davg</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mf">0.25</span>

<span class="n">u10m</span><span class="o">=</span><span class="n">opfc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;uwnd.10m&#39;</span><span class="p">,</span><span class="n">dte</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">)</span>
<span class="n">v10m</span><span class="o">=</span><span class="n">opfc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;vwnd.10m&#39;</span><span class="p">,</span><span class="n">dte</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">)</span>

<span class="c1"># We&#39;re plotting log precip - so interpolate in log space too</span>
<span class="n">precip</span><span class="o">=</span><span class="n">load_li_precip</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>

<span class="n">mask</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/fixed_fields/land_mask/opfc_global_2019.nc&quot;</span> <span class="o">%</span> 
                                                  <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">))</span>
<span class="c1"># Icec is only daily, so interpolate manually</span>
<span class="n">icec</span><span class="o">=</span><span class="n">load_di_icec</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>

<span class="c1"># Remap the t2m to highlight small differences</span>
<span class="n">t2m</span><span class="o">=</span><span class="n">quantile_normalise_t2m</span><span class="p">(</span><span class="n">t2m</span><span class="p">)</span>
<span class="n">t2m</span> <span class="o">*=</span> <span class="mi">1000</span>

<span class="c1"># Define the figure (page size, background color, resolution, ...</span>
<span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">38.4</span><span class="p">,</span><span class="mf">21.6</span><span class="p">),</span>              <span class="c1"># Width, Height (inches)</span>
           <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
           <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
           <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>                <span class="c1"># Don&#39;t draw a frame</span>
           <span class="n">subplotpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">tight_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_frameon</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> 
<span class="c1"># Attach a canvas</span>
<span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># Make the wind noise</span>
<span class="n">wind_pc</span><span class="o">=</span><span class="n">plot_cube</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="o">-</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span>
                      <span class="o">-</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>   
<span class="n">cs</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">RotatedGeogCS</span><span class="p">(</span><span class="mf">90.0</span><span class="p">,</span><span class="mf">180.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">rw</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">cartography</span><span class="o">.</span><span class="n">rotate_winds</span><span class="p">(</span><span class="n">u10m</span><span class="p">,</span><span class="n">v10m</span><span class="p">,</span><span class="n">cs</span><span class="p">)</span>
<span class="n">u10m</span> <span class="o">=</span> <span class="n">rw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">wind_pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">v10m</span> <span class="o">=</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">wind_pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">seq</span><span class="o">=</span><span class="p">(</span><span class="n">dte</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<span class="n">z</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">zfile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">wind_noise_field</span><span class="o">=</span><span class="n">wind_field</span><span class="p">(</span><span class="n">u10m</span><span class="p">,</span><span class="n">v10m</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">sequence</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">seq</span><span class="o">*</span><span class="mi">5</span><span class="p">),</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># Define an axes to contain the plot. In this case our axes covers</span>
<span class="c1">#  the whole figure</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span> <span class="c1"># Don&#39;t want surrounding x and y axis</span>

<span class="c1"># Lat and lon range (in rotated-pole coordinates) for plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="c1"># Background</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Draw lines of latitude and longitude</span>
<span class="n">draw_lat_lon</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">lwd</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">pole_longitude</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pole_longitude</span><span class="p">,</span>
                <span class="n">pole_latitude</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pole_latitude</span><span class="p">,</span>
                <span class="n">npg_longitude</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">npg_longitude</span><span class="p">)</span>

<span class="c1"># Plot the land mask</span>
<span class="n">mask_pc</span><span class="o">=</span><span class="n">plot_cube</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="o">-</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span>
                                  <span class="o">-</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>   
<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">mask_pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">lats</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
<span class="n">mask_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span>
                                <span class="p">((</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span>
                         <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                         <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Plot the sea-ice</span>
<span class="n">ice_pc</span><span class="o">=</span><span class="n">plot_cube</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="o">-</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span>
                      <span class="o">-</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>   
<span class="n">icec</span> <span class="o">=</span> <span class="n">icec</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">ice_pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">icec_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">icec</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span>
                                <span class="p">((</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span>
                         <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                         <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Plot the T2M</span>
<span class="n">t2m_pc</span><span class="o">=</span><span class="n">plot_cube</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="o">-</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span>
                      <span class="o">-</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>   
<span class="n">t2m</span> <span class="o">=</span> <span class="n">t2m</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">t2m_pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="c1"># Adjust to show the wind</span>
<span class="n">wscale</span><span class="o">=</span><span class="mi">200</span>
<span class="n">s</span><span class="o">=</span><span class="n">wind_noise_field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="n">wind_noise_field</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">qcut</span><span class="p">(</span><span class="n">wind_noise_field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">wscale</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">duplicates</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">wscale</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="c1"># Plot as a colour map</span>
<span class="n">wnf</span><span class="o">=</span><span class="n">wind_noise_field</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">t2m</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">t2m_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">t2m</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="n">wnf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="mi">1100</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Plot the precip</span>
<span class="n">precip_pc</span><span class="o">=</span><span class="n">plot_cube</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="o">-</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span>
                         <span class="o">-</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span><span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>   
<span class="n">precip</span> <span class="o">=</span> <span class="n">precip</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">precip_pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">wnf</span><span class="o">=</span><span class="n">wind_noise_field</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">precip</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">wnf</span><span class="o">.</span><span class="n">data</span><span class="o">/</span><span class="mi">1000</span>
<span class="n">cols</span><span class="o">=</span><span class="n">get_precip_colours</span><span class="p">()</span>
<span class="n">precip_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">precip</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span>
                           <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c1"># Label with the date</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="o">-</span><span class="p">(</span><span class="mi">360</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span><span class="o">*</span><span class="mf">0.009</span><span class="p">,</span>
         <span class="mi">90</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="o">-</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span><span class="o">*</span><span class="mf">0.016</span><span class="p">,</span>
         <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">),</span>
         <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
         <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>
                   <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                   <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span>
                   <span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span>
         <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">zorder</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># Render the figure as a png</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%04d%02d%02d%02d%02d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">opdir</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                             <span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                             <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span>
                                             <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hour</span><span class="o">%</span><span class="mi">1</span><span class="o">*</span><span class="mi">60</span><span class="p">)))</span>
</pre></div>
</div>
<p>Library and utility functions used:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="make_z.html">Make the speckles field</a></li>
<li class="toctree-l1"><a class="reference internal" href="load_step.html">Load the weather data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lib/plots.html">Plotting utilities</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="make_z.html" title="Make wind speckles for the MO global analysis video"
             >next</a> |</li>
        <li class="right" >
          <a href="data.html" title="Assemble data for the Met Office Global Analysis video"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ML GCM</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Visualising the Met Office Global Analysis</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>